<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚«ãƒ«ã‚¯ï¼†ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ (FINAL)</title>
    
    <!-- Libraries -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;800&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">

<style>
:root {
    --bg-color: #f0f4f8;
    --text-color: #2c3e50;
    --primary: #3498db; /* é’ (å®ˆã‚Š/è‡ªåˆ†) */
    --accent: #e74c3c;  /* èµ¤ (æ”»æ’ƒ/ç›¸æ‰‹) */
    --gold: #f1c40f;
    --panel-bg: #ffffff;
}

body {
    margin: 0; background: var(--bg-color); color: var(--text-color);
    font-family: 'M PLUS Rounded 1c', sans-serif;
    height: 100vh; overflow: hidden; 
    touch-action: manipulation; user-select: none; -webkit-user-select: none;
    display: flex; justify-content: center; align-items: center;
}

/* ç”»é¢ç®¡ç† */
.screen {
    position: absolute; width: 100%; height: 100%; max-width: 600px;
    display: none; flex-direction: column; align-items: center; justify-content: center;
    background: var(--bg-color); z-index: 1; transition: opacity 0.3s;
}
.screen.active { display: flex; z-index: 10; }

/* HUBãƒœã‚¿ãƒ³ */
.nav-return-btn {
    display: inline-block;
    padding: 8px 16px;
    border-radius: 10px;
    background: rgba(52, 152, 219, 0.15);
    color: #3498db;
    text-decoration: none;
    font-weight: 600;
    font-size: 0.85rem;
    border: 1px solid rgba(52, 152, 219, 0.4);
    position: absolute; top: 20px; left: 20px; z-index: 100;
}
.nav-return-btn:hover { background: rgba(52, 152, 219, 0.3); }

/* å…±é€šUI */
h1 { font-size: 2.2rem; margin-bottom: 10px; text-align: center; color: #34495e; }
.desc { font-size: 0.9rem; color: #7f8c8d; margin-bottom: 30px; text-align: center; }

.btn {
    width: 80%; max-width: 300px; padding: 18px; margin: 10px;
    border: none; border-radius: 12px;
    font-size: 1.1rem; font-weight: bold; cursor: pointer;
    box-shadow: 0 4px 0 rgba(0,0,0,0.1); transition: transform 0.1s;
    background: #fff; color: #555; border: 2px solid #bdc3c7;
}
.btn:active { transform: translateY(4px); box-shadow: none; }
.btn-primary { background: var(--primary); color: #fff; border: none; box-shadow: 0 4px 0 #2980b9; }
.btn-accent { background: var(--accent); color: #fff; border: none; box-shadow: 0 4px 0 #c0392b; }

.input-box {
    font-size: 1.2rem; padding: 12px; width: 70%; text-align: center;
    border: 2px solid #bdc3c7; border-radius: 8px; margin: 10px 0;
}

/* ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç”»é¢ */
#qr-display { background: #fff; padding: 15px; border-radius: 10px; margin: 15px; }
#camera-wrapper { width: 90%; max-width: 300px; margin: 10px; border: 2px solid #333; border-radius: 8px; overflow: hidden; display: none; }

/* ã‚²ãƒ¼ãƒ ç”»é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
.game-layout {
    width: 100%; height: 100%; display: flex; flex-direction: column;
    justify-content: space-between; padding: 10px; box-sizing: border-box;
    position: relative;
}

/* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¨ãƒªã‚¢ */
.player-zone {
    background: rgba(255,255,255,0.7); border-radius: 15px; padding: 10px;
    transition: 0.3s; border: 3px solid transparent; min-height: 120px;
}
.player-zone.turn-atk { border-color: var(--accent); background: #fff5f5; }
.player-zone.turn-def { border-color: var(--primary); background: #f0f8ff; }

.zone-label { font-size: 0.8rem; font-weight: bold; margin-bottom: 5px; display: flex; justify-content: space-between; }
.role-badge { padding: 3px 8px; border-radius: 4px; color: #fff; font-size: 0.7rem; }
.badge-atk { background: var(--accent); }
.badge-def { background: var(--primary); }

.hand-container { display: flex; justify-content: center; gap: 5px; flex-wrap: wrap; }

/* ã‚«ãƒ¼ãƒ‰ */
.card {
    width: 50px; height: 70px;
    background: #fff; border: 2px solid #bdc3c7; border-radius: 8px;
    display: flex; justify-content: center; align-items: center;
    font-size: 1.5rem; font-weight: 900; color: #333;
    box-shadow: 0 3px 0 rgba(0,0,0,0.1); cursor: pointer; position: relative;
    user-select: none;
}
.card:active { transform: translateY(3px); box-shadow: none; }
.card.selected { border-color: var(--gold); background: #fffbe6; transform: translateY(-3px); box-shadow: 0 5px 0 rgba(241, 196, 15, 0.4); }
.card.disabled { opacity: 0.4; pointer-events: none; background: #eee; }
.card-back { background: #34495e; border-color: #2c3e50; color: transparent; }

/* ä¸­å¤®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */
.center-field { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 15px; }
.battle-slots { display: flex; align-items: center; gap: 20px; }
.slot {
    width: 60px; height: 85px; border: 2px dashed #bdc3c7; border-radius: 10px;
    display: flex; justify-content: center; align-items: center; font-size: 0.8rem; color: #95a5a6;
    background: rgba(255,255,255,0.5);
}

.guide-msg {
    background: #34495e; color: #fff; padding: 10px 20px; border-radius: 50px;
    font-size: 0.95rem; font-weight: bold; text-align: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    animation: popIn 0.3s ease; width: 90%; max-width: 400px;
}
@keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

/* è¨ˆç®—ãƒ‘ãƒãƒ« (ä¸‹ã‹ã‚‰ã‚¹ãƒ©ã‚¤ãƒ‰) */
.calc-panel {
    position: absolute; bottom: 0; left: 0; width: 100%; height: 70%;
    background: #fff; border-radius: 20px 20px 0 0;
    box-shadow: 0 -5px 30px rgba(0,0,0,0.2);
    display: flex; flex-direction: column; padding: 15px; box-sizing: border-box;
    transform: translateY(110%); transition: transform 0.3s ease-out; z-index: 50;
}
.calc-panel.show { transform: translateY(0); }

.calc-header { text-align: center; margin-bottom: 10px; color: #7f8c8d; font-size: 0.9rem; }
.calc-target-num { font-size: 2.5rem; font-weight: bold; color: var(--accent); line-height: 1; margin-left: 10px; }

.calc-display {
    background: #ecf0f1; border-radius: 8px; padding: 10px;
    font-size: 1.8rem; text-align: right; font-family: 'Roboto Mono', monospace;
    margin-bottom: 15px; height: 40px; border: 2px solid #bdc3c7; overflow: hidden;
    white-space: nowrap; color: #2c3e50;
}

.calc-chips { display: flex; justify-content: center; gap: 8px; margin-bottom: 15px; }
.chip {
    width: 50px; height: 50px; border-radius: 50%; background: #fff;
    border: 2px solid #bdc3c7; display: flex; justify-content: center; align-items: center;
    font-size: 1.4rem; font-weight: bold; cursor: pointer; color: #3498db;
    box-shadow: 0 3px 0 #bdc3c7;
}
.chip:active { transform: translateY(3px); box-shadow: none; }
.chip.used { opacity: 0.3; pointer-events: none; border-color: #ecf0f1; box-shadow: none; transform: none; }

.calc-hand-area { 
    display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; 
    margin-bottom: auto; padding: 10px; background: #f8f9fa; border-radius: 10px;
}

.calc-btns { display: flex; gap: 10px; margin-top: 10px; }
.btn-calc { flex: 1; padding: 15px; border-radius: 10px; font-weight: bold; border: none; cursor: pointer; color: #fff; font-size: 1rem; }
.btn-clear { background: #95a5a6; box-shadow: 0 4px 0 #7f8c8d; }
.btn-pass { background: #34495e; box-shadow: 0 4px 0 #2c3e50; }
.btn-go { background: var(--accent); box-shadow: 0 4px 0 #c0392b; flex: 2; }
.btn-calc:active { transform: translateY(4px); box-shadow: none; }

/* å¾…æ©Ÿã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
#wait-overlay {
    position: absolute; top:0; left:0; width:100%; height:100%;
    background: rgba(255,255,255,0.8); backdrop-filter: blur(4px);
    display: none; justify-content: center; align-items: center;
    z-index: 20; font-weight: bold; color: #2c3e50; font-size: 1.4rem;
    flex-direction: column; gap: 15px;
}

/* ãƒ¢ãƒ¼ãƒ€ãƒ« (çµæœè¡¨ç¤º) */
.modal {
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%;
    background: rgba(0,0,0,0.85); 
    z-index: 100; /* ã“ã‚Œã§æœ€å‰é¢ã«ãã¾ã™ */
    display: none; 
    flex-direction: column; 
    justify-content: center; 
    align-items: center;
    color: #fff;
}
#result-title { font-size: 3.5rem; margin-bottom: 20px; text-shadow: 0 0 10px var(--gold); }

.blink { animation: blink 1s infinite alternate; }
@keyframes blink { from { opacity: 0.4; } to { opacity: 1; } }

/* ãƒ«ãƒ¼ãƒ«ãƒ‘ãƒãƒ«å†…ã®ãƒ†ã‚­ã‚¹ãƒˆèª¿æ•´ */
#rule-modal p {
    margin-bottom: 15px;
    padding-bottom: 5px;
    border-bottom: 1px dashed #eee;
}
#rule-modal b {
    color: var(--primary);
}
.timer-danger {
    color: #ff0000 !important;
    animation: blink 0.5s infinite alternate;
}
</style>
</head>
<body>
<div id="rule-modal" class="modal" style="display:none; background:rgba(0,0,0,0.95);">
    <div style="background:#fff; color:#333; width:90%; max-width:450px; padding:20px; border-radius:15px; max-height:80vh; overflow-y:auto;">
        <h2 style="margin-top:0; color:var(--accent);">ã‚ãã³ã‹ãŸ</h2>
        <div style="text-align:left; font-size:0.9rem; line-height:1.6;">
            <p><b>ã€å‹åˆ©æ¡ä»¶ã€‘</b><br>å…ˆã«æ‰‹æœ­ã‚’ã™ã¹ã¦ãªãã—ãŸäººã®å‹ã¡ï¼</p>
            <p><b>â‘  ã‚«ãƒ¼ãƒ‰é¸æŠ</b><br>ãŠäº’ã„ã«æ‰‹æœ­ã‹ã‚‰1æšé¸ã‚“ã§å ´ã«å‡ºã—ã¾ã™ã€‚</p>
            <p><b>â‘¡ æ•°å­—ã®åˆ¤å®š</b><br>
                ãƒ»<b>æ•°å­—ãŒåŒã˜ï¼ˆã‚¯ãƒ©ãƒƒã‚·ãƒ¥ï¼‰ï¼š</b><br>ãƒ©ãƒƒã‚­ãƒ¼ï¼ãŠäº’ã„ã«ãã®ã‚«ãƒ¼ãƒ‰ã‚’æ¨ã¦ã¦æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸ã€‚<br>
                ãƒ»<b>æ•°å­—ãŒã¡ãŒã†ï¼š</b><br>ã€Œæ”»æ’ƒã€ã¨ã€Œå®ˆã‚Šã€ã«åˆ†ã‹ã‚Œã¦<b>è¨ˆç®—ãƒãƒˆãƒ«</b>é–‹å§‹ï¼
            </p>
            <p><b>â‘¢ è¨ˆç®—ãƒãƒˆãƒ«ï¼ˆæ”»æ’ƒå´ã®ç•ªï¼‰</b><br>
                æ”»æ’ƒå´ã¯<b>ã€Œè‡ªåˆ†ã®å‡ºã—ãŸã‚«ãƒ¼ãƒ‰ã€</b>ã‚’ä½¿ã„ã€æ‰‹æœ­ã‚„è¨˜å·ï¼ˆï¼‹ï¼Ã—Ã·ï¼‰ã‚’çµ„ã¿åˆã‚ã›ã¦<b>ã€Œç›¸æ‰‹ã®æ•°å­—ã€</b>ã‚’ä½œã‚Šã¾ã™ã€‚<br>
                ãƒ»<b>è¨ˆç®—æˆåŠŸï¼ˆãƒ–ãƒ¬ã‚¤ã‚¯ï¼‰ï¼š</b><br>ç›¸æ‰‹ã®ã‚«ãƒ¼ãƒ‰ã‚’æ¨ã¦ã•ã›ã€è‡ªåˆ†ã‚‚å‡ºã—ãŸã‚«ãƒ¼ãƒ‰ã¨<b>å¼ã«ä½¿ã£ãŸæ‰‹æœ­</b>ã‚’æ¨ã¦ã¾ã™ã€‚<br>
                ãƒ»<b>ã‚ãã‚‰ã‚ã‚‹ï¼ˆã‚¬ãƒ¼ãƒ‰ï¼‰ï¼š</b><br>ç›¸æ‰‹ã®ã‚«ãƒ¼ãƒ‰ã ã‘ãŒæ¨ã¦ã‚‰ã‚Œã€è‡ªåˆ†ã®ã‚«ãƒ¼ãƒ‰ã¯æ‰‹æœ­ã«æˆ»ã‚Šã¾ã™ã€‚
            </p>
            <p style="font-size:0.8rem; color:#666; border-top:1px solid #eee; pt:10px;">
                â€»è¨ˆç®—ã«ä½¿ã†æ‰‹æœ­ãŒå¤šã„ã»ã©ã€ä¸€åº¦ã«ãŸãã•ã‚“ã‚«ãƒ¼ãƒ‰ã‚’æ¸›ã‚‰ã›ã¾ã™ãŒã€å¤±æ•—ã®ãƒªã‚¹ã‚¯ã‚‚é«˜ã¾ã‚Šã¾ã™ï¼
            </p>
        </div>
        <button class="btn btn-primary" style="width:100%; margin:10px 0 0 0;" onclick="document.getElementById('rule-modal').style.display='none'">ã‚ã‹ã£ãŸï¼</button>
    </div>
</div>
<!-- 1. ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ -->
<div id="screen-title" class="screen active">
    <a href="https://kkkkk-a.github.io/game-hub/" class="nav-return-btn" title="Game Hub">HUB</a>
    
    <div style="font-size:3rem; margin-bottom:5px;">ğŸ§®ğŸ’¥</div>
    <h1>ã‚«ãƒ«ã‚¯ï¼†ã‚¯ãƒ©ãƒƒã‚·ãƒ¥</h1>
    <div class="desc">æ•°å­—ã‚’ä½œã£ã¦ç›¸æ‰‹ã®æ‰‹æœ­ã‚’ç ´å£Šã›ã‚ˆï¼</div>
    
    <button class="btn btn-primary" onclick="Game.initLocal()">ã²ã¨ã‚Šã§ç·´ç¿’ (CPUé¢¨)</button>
    <button class="btn btn-accent" onclick="Network.openMenu()">å‹ã ã¡ã¨å¯¾æˆ¦ (é€šä¿¡)</button>
    <div style="margin-top:20px; font-size:0.8rem; color:#bdc3c7;">FINAL FIX</div>
    <button class="btn" style="background:#95a5a6; color:#fff; border:none;" onclick="document.getElementById('rule-modal').style.display='flex'">ãƒ«ãƒ¼ãƒ«ã‚’è¦‹ã‚‹</button>
</div>

<!-- 2. é€šä¿¡ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
<div id="screen-network" class="screen">
    <h2>é€šä¿¡å¯¾æˆ¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
    
    <div id="net-select-ui" style="display:flex; flex-direction:column; align-items:center; width:100%;">
        <button class="btn btn-primary" onclick="Network.initHost()">éƒ¨å±‹ã‚’ã¤ãã‚‹ (ãƒ›ã‚¹ãƒˆ)</button>
        <div style="margin:10px; color:#999;">ã¾ãŸã¯</div>
        <button class="btn btn-accent" onclick="Network.showGuestUI()">éƒ¨å±‹ã«å…¥ã‚‹ (ã‚²ã‚¹ãƒˆ)</button>
        <button class="btn" onclick="location.reload()" style="margin-top:20px;">ã‚‚ã©ã‚‹</button>
    </div>

    <div id="net-host-ui" style="display:none; flex-direction:column; align-items:center; width:100%;">
        <p>ã“ã®QRã‚’ç›¸æ‰‹ã«èª­ã¿å–ã£ã¦ã‚‚ã‚‰ãŠã†</p>
        <div id="qr-display"></div>
        <div style="font-size:0.9rem; margin-bottom:10px;">ã‚³ãƒ¼ãƒ‰: <span id="host-id-text" style="font-weight:bold; color:var(--primary);">ç”Ÿæˆä¸­...</span></div>
        <div class="guide-msg blink" style="background:var(--accent);">ç›¸æ‰‹ã®æ¥ç¶šå¾…ã¡...</div>
        <button class="btn" onclick="location.reload()" style="margin-top:20px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>

    <div id="net-guest-ui" style="display:none; flex-direction:column; align-items:center; width:100%;">
        <div id="camera-wrapper"></div>
        <button class="btn btn-primary" onclick="Network.startCamera()">ğŸ“· QRã‚¹ã‚­ãƒ£ãƒ³</button>
        <div style="margin:10px; color:#999;">ã¾ãŸã¯</div>
        <input type="text" id="input-host-id" class="input-box" placeholder="æ‹›å¾…ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
        <button class="btn btn-accent" onclick="Network.joinByInput()">ã‚³ãƒ¼ãƒ‰ã§å‚åŠ </button>
        <button class="btn" onclick="location.reload()" style="margin-top:20px;">ã‚‚ã©ã‚‹</button>
    </div>
</div>

<!-- 3. ã‚²ãƒ¼ãƒ ç”»é¢ -->
<div id="screen-game" class="screen">
    <div class="game-layout">
        
        <!-- ç›¸æ‰‹ã‚¨ãƒªã‚¢ -->
        <div id="zone-p2" class="player-zone">
            <div class="zone-label">
                <span>ã‚ã„ã¦</span>
                <span id="badge-p2" class="role-badge"></span>
            </div>
            <div id="hand-p2" class="hand-container"></div>
        </div>

        <!-- ä¸­å¤®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
        <div class="center-field">
            <div id="game-timer" style="font-family:'Roboto Mono'; font-size:2rem; font-weight:bold; color:var(--accent); margin-bottom:5px; text-shadow:0 0 10px rgba(231,76,60,0.3); display:none;">
    20
</div>
            <div id="guide-text" class="guide-msg">ã‚²ãƒ¼ãƒ é–‹å§‹ï¼</div>
            <div class="battle-slots">
                <div id="slot-p2" class="slot">ã‚ã„ã¦</div>
                <div style="font-weight:bold; color:#bdc3c7;">VS</div>
                <div id="slot-p1" class="slot">ã‚ãªãŸ</div>
            </div>
        </div>

        <!-- è‡ªåˆ†ã‚¨ãƒªã‚¢ -->
        <div id="zone-p1" class="player-zone">
            <div class="zone-label">
                <span>ã‚ãªãŸ</span>
                <span id="badge-p1" class="role-badge"></span>
            </div>
            <div id="hand-p1" class="hand-container"></div>
        </div>

        <!-- è¨ˆç®—ãƒ‘ãƒãƒ« -->
        <div id="calc-panel" class="calc-panel">
            <div class="calc-header">
                ç›®æ¨™ã®æ•°å­—ã‚’ä½œã‚Œï¼ <span id="calc-target" class="calc-target-num">?</span>
            </div>
            <div id="calc-disp" class="calc-display"></div>
            
            <div id="calc-chips" class="calc-chips"></div>
            <div id="calc-hand" class="calc-hand-area"></div>

            <div class="calc-btns">
                <button class="btn-calc btn-clear" onclick="Game.calcClear()">ã‚¯ãƒªã‚¢</button>
                <button class="btn-calc btn-pass" onclick="Game.calcPass()">ãƒ‘ã‚¹</button>
                <button class="btn-calc btn-go" onclick="Game.calcSubmit()">æ±ºå®š</button>
            </div>
        </div>

        <!-- å¾…æ©Ÿã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
        <div id="wait-overlay">
            <div class="blink" style="font-size:3rem;">â³</div>
            <div id="wait-text">ç›¸æ‰‹ã‚’å¾…ã£ã¦ã„ã¾ã™...</div>
        </div>
    </div>
</div>

<!-- 4. çµæœç”»é¢ -->
<div id="result-modal" class="modal">
    <div id="result-title">WIN!</div>
    <div id="result-detail" style="margin-bottom:30px; font-size:1.2rem;">ç›¸æ‰‹ã®æ‰‹æœ­ãŒå°½ãã¾ã—ãŸ</div>
    <button class="btn btn-primary" onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
</div>

<script>
    // ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ãªã©ã§ã€Œãƒ«ãƒ¼ãƒ«ã‚’è¦‹ã‚‹ã€ã‚’æŠ¼ã—ãŸæ™‚ã®å‡¦ç†
// (HTMLå´ã® onclick ã§å®Œçµã—ã¦ã„ã¾ã™ãŒã€Escã‚­ãƒ¼ã§é–‰ã˜ãŸã„å ´åˆã¯ä»¥ä¸‹ã‚’è¿½åŠ )
window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        document.getElementById('rule-modal').style.display = 'none';
    }
});
/**
 * CALC & CRASH - FINAL FIX
 * - æ—¥æœ¬èªåŒ–
 * - é›»å“é¢¨UIã«ã‚ˆã‚‹ã‚¹ãƒãƒ›æ“ä½œæ€§å‘ä¸Š
 * - å®‰å…¨ãªè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
 * - HUBãƒœã‚¿ãƒ³æ­è¼‰
 */

// éŸ³å£°ç®¡ç†
const Sound = {
    ctx: null,
    init() { if(!this.ctx) this.ctx = new (window.AudioContext||window.webkitAudioContext)(); },
    play(type) {
        if(!this.ctx) return;
        const t = this.ctx.currentTime;
        const o = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        o.connect(g); g.connect(this.ctx.destination);
        
        if(type === 'select') {
            o.frequency.setValueAtTime(800, t); g.gain.exponentialRampToValueAtTime(0.01, t+0.1); o.start(); o.stop(t+0.1);
        } else if(type === 'crash') {
            o.type = 'sawtooth'; o.frequency.setValueAtTime(100, t); g.gain.exponentialRampToValueAtTime(0.01, t+0.3); o.start(); o.stop(t+0.3);
        } else if(type === 'win') {
            o.type = 'triangle'; o.frequency.setValueAtTime(440, t); o.frequency.setValueAtTime(880, t+0.1); g.gain.linearRampToValueAtTime(0, t+0.4); o.start(); o.stop(t+0.4);
        } else if(type === 'error') {
            o.type = 'square'; o.frequency.setValueAtTime(150, t); g.gain.linearRampToValueAtTime(0, t+0.2); o.start(); o.stop(t+0.2);
        }
    }
};

// ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç®¡ç†
const Network = {
    peer: null, conn: null, isHost: false, scanner: null,
    
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤º
    openMenu() {
        document.querySelectorAll('.screen').forEach(e => e.classList.remove('active'));
        document.getElementById('screen-network').classList.add('active');
        document.getElementById('net-select-ui').style.display='flex';
        document.getElementById('net-host-ui').style.display='none';
        document.getElementById('net-guest-ui').style.display='none';
    },

    initHost() {
        Sound.init();
        document.getElementById('net-select-ui').style.display = 'none';
        document.getElementById('net-host-ui').style.display = 'flex';
        
        this.peer = new Peer();
        this.peer.on('open', id => {
            document.getElementById('host-id-text').innerText = id;
            this.isHost = true;
            document.getElementById("qr-display").innerHTML = "";
            new QRCode(document.getElementById("qr-display"), { text: id, width: 160, height: 160 });
        });
        
        this.peer.on('connection', c => {
            this.conn = c; this.setupConnection(); Game.startOnline(true);
        });
    },

    showGuestUI() {
        document.getElementById('net-select-ui').style.display = 'none';
        document.getElementById('net-guest-ui').style.display = 'flex';
    },

    startCamera() {
        Sound.init();
        const wrapper = document.getElementById('camera-wrapper');
        wrapper.style.display = 'block';
        this.scanner = new Html5QrcodeScanner("camera-wrapper", { fps: 10, qrbox: 200 });
        this.scanner.render((decoded) => {
            this.join(decoded); this.scanner.clear(); wrapper.style.display = 'none';
        });
    },

    joinByInput() {
        const id = document.getElementById('input-host-id').value;
        if(id) this.join(id);
    },

    join(id) {
        Sound.init();
        this.peer = new Peer();
        this.peer.on('open', () => {
            this.conn = this.peer.connect(id);
            this.isHost = false;
            this.setupConnection();
            Game.startOnline(false);
        });
        this.peer.on('error', () => alert("æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸ"));
    },

    setupConnection() {
        this.conn.on('data', data => Game.onData(data));
        this.conn.on('close', () => alert("é€šä¿¡ãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ"));
    },

    send(data) { if(this.conn) this.conn.send(data); }
};

// ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯
const Game = {
    mode: 'local', role: 'p1',
    p1: { hand:[1,2,3,5,7,9], chips:['+','-','*','/'], select:null },
    p2: { hand:[1,2,3,5,7,9], chips:['+','-','*','/'], select:null },
    attacker: 'p1', phase: 'select', calcBuffer: [],    timer: 20,
    timerId: null,

        startTimer(seconds, onTimeout) {
        this.stopTimer();
        this.timer = seconds;
        const el = document.getElementById('game-timer');
        el.style.display = 'block';
        el.innerText = this.timer;
        el.classList.remove('timer-danger');

        this.timerId = setInterval(() => {
            this.timer--;
            el.innerText = this.timer;
            if (this.timer <= 5) el.classList.add('timer-danger');
            
            if (this.timer <= 0) {
                this.stopTimer();
                onTimeout(); // æ™‚é–“åˆ‡ã‚Œæ™‚ã®å‡¦ç†ã‚’å®Ÿè¡Œ
            }
        }, 1000);
    },

    // ã‚¿ã‚¤ãƒãƒ¼ã‚’æ­¢ã‚ã‚‹é–¢æ•°
    stopTimer() {
        if (this.timerId) clearInterval(this.timerId);
        document.getElementById('game-timer').style.display = 'none';
    },

    initLocal() { Sound.init(); this.mode = 'local'; this.role = 'p1'; this.start(); },
    startOnline(isHost) { this.mode = 'online'; this.role = isHost ? 'p1' : 'p2'; this.start(); },

    start() {
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        document.getElementById('screen-game').classList.add('active');
        
        this.attacker = (Math.random() > 0.5) ? 'p1' : 'p2';
        
        if(this.mode === 'online' && this.role === 'p1') {
            Network.send({ type: 'init', attacker: this.attacker });
        }
        
        this.updateBoard();
        this.startPhaseSelect();
    },

   startPhaseSelect() {
        this.phase = 'select';
        this.p1.select = null; this.p2.select = null;
        document.getElementById('slot-p1').innerHTML = 'ã‚ãªãŸ';
        document.getElementById('slot-p2').innerHTML = 'ã‚ã„ã¦';
        document.getElementById('wait-overlay').style.display = 'none';
        this.setGuide(this.mode==='local' ? "ã€P1ã€‘ã‚«ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ãã ã•ã„" : "å ´ã«å‡ºã™ã‚«ãƒ¼ãƒ‰ã‚’é¸ã¼ã†ï¼");
        this.updateBoard();

        // --- è¿½åŠ ï¼šåˆ¶é™æ™‚é–“ï¼ˆé¸ã°ãªã‹ã£ãŸã‚‰ä¸€ç•ªå·¦ã®ã‚«ãƒ¼ãƒ‰ã‚’å¼·åˆ¶é¸æŠï¼‰ ---
        this.startTimer(20, () => {
            const p = (this.mode === 'online') ? this[this.role] : this.p1;
            if (p.select === null) this.clickCard(this.mode==='online'?this.role:'p1', p.hand[0]);
        });
    },

    clickCard(player, val) {
        if(this.phase !== 'select') return;
        if(this.mode === 'online' && player !== this.role) return;
        if(this.mode === 'local' && player === 'p2' && this.p1.select === null) return;

        this[player].select = val;
        Sound.play('select');

        if(this.mode === 'local') {
            if(player === 'p1') {
                document.getElementById('slot-p1').innerHTML = '<div class="card card-back"></div>';
                this.setGuide("ã€P2ã€‘ã‚«ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ãã ã•ã„");
            } else {
                document.getElementById('slot-p2').innerHTML = '<div class="card card-back"></div>';
                setTimeout(() => this.revealCards(), 500);
            }
        } else {
            document.getElementById(`slot-${this.role}`).innerHTML = '<div class="card card-back"></div>';
            Network.send({ type: 'select', val: val });
            this.setGuide("ç›¸æ‰‹ã‚’å¾…ã£ã¦ã„ã¾ã™...");
            document.getElementById('wait-overlay').style.display = 'flex';
            document.getElementById('wait-text').innerText = "ç›¸æ‰‹ã®é¸æŠä¸­...";
            this.checkOnlineReady();
        }
        this.updateBoard();
    },

    checkOnlineReady() {
        if(this.p1.select !== null && this.p2.select !== null) {
            document.getElementById('wait-overlay').style.display = 'none';
            setTimeout(() => this.revealCards(), 500);
        }
    },

    revealCards() {
        this.phase = 'reveal';
        const v1 = this.p1.select;
        const v2 = this.p2.select;
        
        document.getElementById('slot-p1').innerHTML = `<div class="card">${v1}</div>`;
        document.getElementById('slot-p2').innerHTML = `<div class="card">${v2}</div>`;
        
        if(v1 === v2) {
            Sound.play('crash');
            this.setGuide("ã€ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ï¼ã€‘åŒã˜æ•°å­—ã ï¼");
            setTimeout(() => {
                this.discard('p1', v1); this.discard('p2', v2); this.checkWinCondition();
            }, 2000);
        } else {
            Sound.play('select');
            this.setGuide("æ•°å­—ãŒé•ã†ï¼è¨ˆç®—ãƒãƒˆãƒ«ç™ºç”Ÿï¼");
            setTimeout(() => this.startPhaseCalc(), 1500);
        }
    },

    startPhaseCalc() {
        this.phase = 'calc';
        const isAttacker = (this.mode === 'local') ? true : (this.role === this.attacker);
        const target = (this.attacker === 'p1') ? this.p2.select : this.p1.select;
        const myCard = (this.attacker === 'p1') ? this.p1.select : this.p2.select;

        this.updateBoard();

        if(isAttacker) {
            this.calcBuffer = [{ type:'num', val:myCard }];
            document.getElementById('calc-target').innerText = target;
            document.getElementById('calc-panel').classList.add('show');
            this.setGuide("ã€æ”»æ’ƒã€‘è¨ˆç®—ã—ã¦ç›¸æ‰‹ã®æ•°å­—ã‚’ä½œã‚Œï¼");
            this.renderCalcUI();
            this.startTimer(40, () => this.calcPass());
        } else {
            this.setGuide("ã€å®ˆã‚Šã€‘ç›¸æ‰‹ã®è¨ˆç®—ã‚’å¾…ã£ã¦ã„ã¾ã™...");
            document.getElementById('wait-overlay').style.display = 'flex';
            document.getElementById('wait-text').innerText = "ç›¸æ‰‹ãŒè¨ˆç®—ä¸­...";
            this.stopTimer(); 
        }
    },

    renderCalcUI() {
        const p = this[this.attacker];
        document.getElementById('calc-disp').innerText = this.calcBuffer.map(i => i.val).join(' ');

        const chipBox = document.getElementById('calc-chips');
        chipBox.innerHTML = '';
        ['+','-','*','/'].forEach(op => {
            const el = document.createElement('div');
            el.className = 'chip'; el.innerText = op;
            const hasCount = p.chips.filter(c => c===op).length;
            const usedCount = this.calcBuffer.filter(i => i.type==='op' && i.val===op).length;
            if(usedCount >= hasCount) el.classList.add('used');
            el.onclick = () => { if(!el.classList.contains('used')) { this.calcBuffer.push({ type:'op', val:op }); Sound.play('select'); this.renderCalcUI(); } };
            chipBox.appendChild(el);
        });

        const handBox = document.getElementById('calc-hand');
        handBox.innerHTML = '';
        p.hand.forEach(val => {
            const el = document.createElement('div');
            el.className = 'card';
            el.style.width='40px'; el.style.height='55px'; el.style.fontSize='1.2rem';
            el.innerText = val;
            const isPlayedCard = (val === p.select);
            const handCount = p.hand.filter(v => v===val).length;
            const usedInBuf = this.calcBuffer.slice(1).filter(i => i.type==='num' && i.val===val).length;
            const limit = isPlayedCard ? handCount - 1 : handCount;
            if(usedInBuf >= limit) el.classList.add('disabled');
            el.onclick = () => { if(!el.classList.contains('disabled')) { this.calcBuffer.push({ type:'num', val:val }); Sound.play('select'); this.renderCalcUI(); } };
            handBox.appendChild(el);
        });
    },

    calcClear() {
        const myCard = (this.attacker === 'p1') ? this.p1.select : this.p2.select;
        this.calcBuffer = [{ type:'num', val:myCard }];
        Sound.play('select'); this.renderCalcUI();
    },
    
    calcPass() {
        if(!confirm("è¨ˆç®—ã‚’ã‚ãã‚‰ã‚ã¾ã™ã‹ï¼Ÿï¼ˆæ”»æ’ƒã‚«ãƒ¼ãƒ‰ã¯æˆ»ã‚Šã¾ã™ï¼‰")) return;
        this.finishCalc(false);
    },

    calcSubmit() {
        const target = (this.attacker === 'p1') ? this.p2.select : this.p1.select;
        const expr = this.calcBuffer.map(i => i.val).join('');
        try {
            if(expr.includes('/0')) throw new Error("ZeroDiv");
            const res = Function('"use strict";return (' + expr + ')')();
            if(!isFinite(res)) throw new Error("Infinity");
            
            if(res === target) {
                Sound.play('win'); this.finishCalc(true);
            } else {
                Sound.play('error'); alert(`ç­”ãˆãŒé•ã„ã¾ã™ï¼\nã‚ãªãŸã®ç­”ãˆ: ${res}\nç›®æ¨™ã®æ•°å­—: ${target}`);
            }
        } catch(e) {
            Sound.play('error'); alert("è¨ˆç®—å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“");
        }
    },

    finishCalc(success) {
        document.getElementById('calc-panel').classList.remove('show');
        if(this.mode === 'online') Network.send({ type: 'result', success: success, buffer: this.calcBuffer });
        this.resolveRound(success);
    },

    resolveRound(success) {
        this.stopTimer();
        document.getElementById('wait-overlay').style.display = 'none';
        if(success) {
            this.setGuide("è¨ˆç®—æˆåŠŸï¼ ä¸¡æ–¹ã®ã‚«ãƒ¼ãƒ‰ãŒæ¶ˆæ»…ï¼");
            const atkPlayer = this[this.attacker];
            for(let i=1; i<this.calcBuffer.length; i++) {
                const item = this.calcBuffer[i];
                if(item.type === 'num') {
                    const idx = atkPlayer.hand.indexOf(item.val);
                    if(idx !== -1) atkPlayer.hand.splice(idx, 1);
                } else {
                    const idx = atkPlayer.chips.indexOf(item.val);
                    if(idx !== -1) atkPlayer.chips.splice(idx, 1);
                }
            }
            this.discard(this.attacker, this[this.attacker].select);
            const def = (this.attacker === 'p1') ? 'p2' : 'p1';
            this.discard(def, this[def].select);
        } else {
            this.setGuide("å¤±æ•—... å®ˆå‚™å´ã®ã‚«ãƒ¼ãƒ‰ã ã‘æ¶ˆæ»…");
            const def = (this.attacker === 'p1') ? 'p2' : 'p1';
            this.discard(def, this[def].select);
        }
        setTimeout(() => this.checkWinCondition(), 2500);
    },

    discard(player, val) {
        const arr = this[player].hand;
        const idx = arr.indexOf(val);
        if(idx !== -1) arr.splice(idx, 1);
    },

    checkWinCondition() {
        const p1Empty = (this.p1.hand.length === 0);
        const p2Empty = (this.p2.hand.length === 0);
        
        if(p1Empty && p2Empty) this.showResult("å¼•ãåˆ†ã‘ï¼");
        else if(p1Empty) this.showResult(this.mode==='local' ? "ã‚ãªãŸ(P1)ã®å‹ã¡ï¼" : (this.role==='p1'?"ã‚ãªãŸã®å‹ã¡ï¼":"ã‚ã„ã¦ã®å‹ã¡ï¼"));
        else if(p2Empty) this.showResult(this.mode==='local' ? "ã‚ã„ã¦(P2)ã®å‹ã¡ï¼" : (this.role==='p2'?"ã‚ãªãŸã®å‹ã¡ï¼":"ã‚ã„ã¦ã®å‹ã¡ï¼"));
        else {
            this.attacker = (this.attacker === 'p1') ? 'p2' : 'p1';
            this.startPhaseSelect();
        }
    },

    showResult(msg) {
        document.getElementById('result-modal').style.display = 'flex';
        document.getElementById('result-title').innerText = msg;
    },

    updateBoard() {
        this.renderHand('p1'); this.renderHand('p2');
        const atkBadge = (this.attacker === 'p1') ? document.getElementById('badge-p1') : document.getElementById('badge-p2');
        const defBadge = (this.attacker === 'p1') ? document.getElementById('badge-p2') : document.getElementById('badge-p1');
        atkBadge.className = 'role-badge badge-atk'; atkBadge.innerText = 'æ”»æ’ƒ';
        defBadge.className = 'role-badge badge-def'; defBadge.innerText = 'å®ˆã‚Š';
        document.getElementById('zone-p1').className = (this.attacker==='p1') ? 'player-zone turn-atk' : 'player-zone turn-def';
        document.getElementById('zone-p2').className = (this.attacker==='p2') ? 'player-zone turn-atk' : 'player-zone turn-def';
    },

    renderHand(player) {
        const container = document.getElementById('hand-'+player);
        container.innerHTML = '';
        const p = this[player];
        const isSecret = (this.mode === 'online' && player !== this.role);

        p.hand.forEach(val => {
            const el = document.createElement('div');
            el.className = 'card';
            if(isSecret) el.classList.add('card-back');
            else {
                el.innerText = val;
                if(this.phase === 'select') {
                    if(p.select === val) el.classList.add('selected');
                    else if(p.select !== null) el.classList.add('disabled');
                    el.onclick = () => this.clickCard(player, val);
                }
            }
            container.appendChild(el);
        });
    },

    setGuide(txt) { document.getElementById('guide-text').innerText = txt; },

    onData(d) {
        if(d.type === 'init') { this.attacker = d.attacker; this.startPhaseSelect(); } 
        else if(d.type === 'select') {
            const opp = (this.role === 'p1') ? 'p2' : 'p1';
            this[opp].select = d.val;
            document.getElementById('slot-'+opp).innerHTML = '<div class="card card-back"></div>';
            this.checkOnlineReady();
        } 
        else if(d.type === 'result') {
            this.calcBuffer = d.buffer; 
            this.resolveRound(d.success);
        }
    }
};
</script>
</body>
</html>
