<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚«ãƒ«ã‚¯ï¼†ã‚¯ãƒ©ãƒƒã‚·ãƒ¥</title>
    
    <!-- å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;900&display=swap" rel="stylesheet">

<style>
/* --- ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š --- */
:root {
    --bg-color: #f4f7f6;
    --text-color: #2c3e50;
    --primary: #3498db; /* é’ï¼ˆè‡ªåˆ†/å®ˆã‚Šï¼‰ */
    --accent: #e74c3c;  /* èµ¤ï¼ˆæ•µ/æ”»æ’ƒï¼‰ */
    --gold: #f1c40f;    /* å¼·èª¿ */
    --card-w: 55px;
    --card-h: 75px;
}

body {
    margin: 0; background: var(--bg-color); color: var(--text-color);
    font-family: 'M PLUS Rounded 1c', sans-serif;
    height: 100vh; display: flex; justify-content: center; align-items: center;
    touch-action: manipulation; user-select: none; overflow: hidden;
}

/* ç”»é¢ç®¡ç† */
.screen {
    position: absolute; width: 100%; height: 100%; max-width: 600px;
    display: none; flex-direction: column; align-items: center; justify-content: center;
    background: var(--bg-color); transition: opacity 0.3s;
}
.screen.active { display: flex; z-index: 10; }

/* å…±é€šãƒ‘ãƒ¼ãƒ„ */
h1 { font-size: 2rem; margin-bottom: 30px; text-align: center; line-height: 1.2; color: #34495e; }
h2 { font-size: 1.5rem; margin-bottom: 20px; color: #34495e; }

.btn {
    width: 80%; max-width: 300px; padding: 18px; margin: 8px;
    border: none; border-radius: 12px;
    font-size: 1.1rem; font-weight: bold; cursor: pointer;
    box-shadow: 0 4px 0 rgba(0,0,0,0.1); transition: transform 0.1s;
    background: #fff; color: #555; border: 2px solid #ddd;
}
.btn:active { transform: translateY(4px); box-shadow: none; }
.btn-primary { background: var(--primary); color: #fff; border: none; box-shadow: 0 4px 0 #2980b9; }
.btn-accent { background: var(--accent); color: #fff; border: none; box-shadow: 0 4px 0 #c0392b; }

.input-box {
    font-size: 1.2rem; padding: 12px; width: 80%; text-align: center;
    border: 2px solid #ccc; border-radius: 8px; margin: 10px 0;
    font-family: inherit;
}

/* QRã‚¨ãƒªã‚¢ */
#qr-display-area { background: #fff; padding: 15px; border-radius: 10px; margin: 15px; }
#camera-wrapper { width: 90%; max-width: 300px; margin: 10px; border: 2px solid #333; display: none; background: #000; }

/* --- ã‚²ãƒ¼ãƒ ç”»é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
.game-layout {
    width: 100%; height: 100%; display: flex; flex-direction: column;
    justify-content: space-between; padding: 10px; box-sizing: border-box;
    position: relative;
}

/* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¨ãƒªã‚¢ */
.player-zone {
    background: rgba(255,255,255,0.6); border-radius: 15px; padding: 10px;
    transition: 0.3s; border: 3px solid transparent; min-height: 110px;
}
.player-zone.turn-atk { border-color: var(--accent); background: #fff0f0; } /* æ”»æ’ƒä¸­ */
.player-zone.turn-def { border-color: var(--primary); background: #f0f8ff; } /* å®ˆå‚™ä¸­ */

.zone-label { font-size: 0.8rem; font-weight: bold; margin-bottom: 5px; display: flex; justify-content: space-between; }
.role-badge { padding: 2px 6px; border-radius: 4px; color: #fff; font-size: 0.7rem; }
.badge-atk { background: var(--accent); }
.badge-def { background: var(--primary); }

.hand { display: flex; justify-content: center; gap: 5px; flex-wrap: wrap; }

/* ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
.card {
    width: var(--card-w); height: var(--card-h);
    background: #fff; border: 2px solid #ccc; border-radius: 8px;
    display: flex; justify-content: center; align-items: center;
    font-size: 1.6rem; font-weight: 900; color: #333;
    box-shadow: 0 3px 6px rgba(0,0,0,0.1); cursor: pointer; position: relative;
}
.card.selected { border-color: var(--gold); background: #fffbe6; transform: translateY(-5px); box-shadow: 0 5px 10px rgba(241, 196, 15, 0.4); }
.card.disabled { opacity: 0.4; pointer-events: none; background: #eee; }
.card-back { background: #34495e; border-color: #2c3e50; }
.card-back::after { content: "?"; color: rgba(255,255,255,0.1); font-size: 2rem; }

/* ä¸­å¤®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */
.center-field { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 15px; }
.battle-slots { display: flex; align-items: center; gap: 20px; }
.slot {
    width: 65px; height: 90px; border: 2px dashed #bbb; border-radius: 10px;
    display: flex; justify-content: center; align-items: center; font-size: 0.8rem; color: #aaa;
}

/* ã‚¬ã‚¤ãƒ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
.guide-msg {
    background: #2c3e50; color: #fff; padding: 10px 25px; border-radius: 50px;
    font-size: 1rem; font-weight: bold; text-align: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
@keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

/* è¨ˆç®—æ©Ÿãƒ‘ãƒãƒ« (ä¸‹ã‹ã‚‰ã‚¹ãƒ©ã‚¤ãƒ‰) */
.calc-panel {
    position: absolute; bottom: 0; left: 0; width: 100%; height: 65%;
    background: #fff; border-radius: 20px 20px 0 0;
    box-shadow: 0 -5px 25px rgba(0,0,0,0.2);
    display: flex; flex-direction: column; padding: 20px; box-sizing: border-box;
    transform: translateY(110%); transition: transform 0.3s ease-out; z-index: 50;
}
.calc-panel.show { transform: translateY(0); }

.calc-header { text-align: center; margin-bottom: 10px; color: #666; font-size: 0.9rem; }
.calc-target-num { font-size: 2.2rem; font-weight: bold; color: var(--accent); line-height: 1; }

.calc-display {
    background: #ecf0f1; border-radius: 8px; padding: 10px;
    font-size: 1.8rem; text-align: right; font-family: monospace;
    margin-bottom: 15px; height: 40px; border: 1px solid #ddd;
}

.calc-chips { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
.chip {
    width: 45px; height: 45px; border-radius: 50%; background: #fff;
    border: 2px solid #ddd; display: flex; justify-content: center; align-items: center;
    font-size: 1.2rem; font-weight: bold; cursor: pointer;
}
.chip:active { background: #ddd; }
.chip.used { opacity: 0.3; pointer-events: none; border-color: #eee; }

.calc-hand-area { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; margin-bottom: auto; }

.calc-btns { display: flex; gap: 10px; margin-top: 10px; }
.btn-calc { flex: 1; padding: 15px; border-radius: 10px; font-weight: bold; border: none; cursor: pointer; color: #fff; }
.btn-clear { background: #95a5a6; }
.btn-pass { background: #7f8c8d; }
.btn-go { background: var(--accent); box-shadow: 0 4px 0 #c0392b; }

/* å¾…æ©Ÿã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
#wait-overlay {
    position: absolute; top:0; left:0; width:100%; height:100%;
    background: rgba(255,255,255,0.7); backdrop-filter: blur(2px);
    display: none; justify-content: center; align-items: center;
    z-index: 20; font-weight: bold; color: #2c3e50; font-size: 1.2rem;
    flex-direction: column; gap: 10px;
}

/* ãƒ¢ãƒ¼ãƒ€ãƒ« (çµæœè¡¨ç¤º) */
#result-modal {
    position: fixed; top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.85); z-index: 100;
    display: none; flex-direction: column; justify-content: center; align-items: center;
    color: #fff;
}
#result-title { font-size: 3rem; margin-bottom: 20px; text-shadow: 0 0 10px var(--gold); }
</style>
</head>
<body>

<!-- 1. ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ -->
<div id="screen-title" class="screen active">
    <div style="font-size:3rem; margin-bottom:10px;">ğŸ§®ğŸ’¥</div>
    <h1>ã‚«ãƒ«ã‚¯ï¼†ã‚¯ãƒ©ãƒƒã‚·ãƒ¥<br><span style="font-size:1rem; color:#7f8c8d;">æ•°å­—ã‚’ä½œã£ã¦ç›¸æ‰‹ã‚’å£Šã›ï¼</span></h1>
    
    <button class="btn btn-primary" onclick="Game.initLocal()">ã²ã¨ã‚Šã§ç·´ç¿’ (CPUé¢¨)</button>
    <button class="btn btn-accent" onclick="Network.openMenu()">å‹ã ã¡ã¨å¯¾æˆ¦ (é€šä¿¡)</button>
<a href="https://kkkkk-a.github.io/game-hub/"
   class="nav-return-btn"
   title="Game Hub"style=".nav-return-btn {
    display: inline-block;
    padding: 8px 16px;
    border-radius: 10px;
    background: rgba(0, 210, 255, 0.15);
    color: #00d2ff;
    text-decoration: none;
    font-weight: 600;
    font-size: 0.85rem;
    border: 1px solid rgba(0, 210, 255, 0.4);
}

.nav-return-btn:hover {
    background: rgba(0, 210, 255, 0.3);
}
">
  HUB
</a>

</div>

<!-- 2. é€šä¿¡ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
<div id="screen-network" class="screen">
    <h2>é€šä¿¡å¯¾æˆ¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
    
    <!-- é¸æŠç”»é¢ -->
    <div id="net-select-ui" style="display:flex; flex-direction:column; align-items:center; width:100%;">
        <button class="btn btn-primary" onclick="Network.initHost()">éƒ¨å±‹ã‚’ã¤ãã‚‹ (ãƒ›ã‚¹ãƒˆ)</button>
        <div style="margin:10px; color:#999;">ã¾ãŸã¯</div>
        <button class="btn btn-accent" onclick="Network.showGuestUI()">éƒ¨å±‹ã«å…¥ã‚‹ (ã‚²ã‚¹ãƒˆ)</button>
        <button class="btn" onclick="location.reload()" style="margin-top:20px;">ã‚‚ã©ã‚‹</button>
    </div>

    <!-- ãƒ›ã‚¹ãƒˆç”»é¢: QRè¡¨ç¤º -->
    <div id="net-host-ui" style="display:none; flex-direction:column; align-items:center; width:100%;">
        <p>ã“ã®QRã‚’ç›¸æ‰‹ã«èª­ã¿å–ã£ã¦ã‚‚ã‚‰ãŠã†</p>
        <div id="qr-display-area"></div>
        <div style="font-size:0.9rem; margin-bottom:10px;">ã‚³ãƒ¼ãƒ‰: <span id="host-id-text" style="font-weight:bold; color:var(--primary);">ç”Ÿæˆä¸­...</span></div>
        <div class="guide-msg" style="background:var(--accent);">ç›¸æ‰‹ã®æ¥ç¶šå¾…ã¡...</div>
        <button class="btn" onclick="location.reload()" style="margin-top:20px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>

    <!-- ã‚²ã‚¹ãƒˆç”»é¢: ã‚«ãƒ¡ãƒ©/å…¥åŠ› -->
    <div id="net-guest-ui" style="display:none; flex-direction:column; align-items:center; width:100%;">
        <div id="camera-wrapper"></div>
        <button class="btn btn-primary" onclick="Network.startCamera()">ğŸ“· QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹</button>
        <div style="margin:10px; color:#999;">ã¾ãŸã¯</div>
        <input type="text" id="input-host-id" class="input-box" placeholder="æ‹›å¾…ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
        <button class="btn btn-accent" onclick="Network.joinByInput()">ã‚³ãƒ¼ãƒ‰ã§å‚åŠ </button>
        <button class="btn" onclick="location.reload()" style="margin-top:20px;">ã‚‚ã©ã‚‹</button>
    </div>
</div>

<!-- 3. ã‚²ãƒ¼ãƒ ç”»é¢ -->
<div id="screen-game" class="screen">
    <div class="game-layout">
        
        <!-- ç›¸æ‰‹ã‚¨ãƒªã‚¢ -->
        <div id="zone-p2" class="player-zone">
            <div class="zone-label">
                <span>ã‚ã„ã¦</span>
                <span id="badge-p2" class="role-badge"></span>
            </div>
            <div id="hand-p2" class="hand"></div>
        </div>

        <!-- ä¸­å¤®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
        <div class="center-field">
            <div id="guide-text" class="guide-msg">ã‚²ãƒ¼ãƒ é–‹å§‹ï¼</div>
            <div class="battle-slots">
                <div id="slot-p2" class="slot">ã‚ã„ã¦</div>
                <div style="font-weight:bold; color:#ccc;">VS</div>
                <div id="slot-p1" class="slot">ã‚ãªãŸ</div>
            </div>
        </div>

        <!-- è‡ªåˆ†ã‚¨ãƒªã‚¢ -->
        <div id="zone-p1" class="player-zone">
            <div class="zone-label">
                <span>ã‚ãªãŸ</span>
                <span id="badge-p1" class="role-badge"></span>
            </div>
            <div id="hand-p1" class="hand"></div>
        </div>

        <!-- è¨ˆç®—ãƒ‘ãƒãƒ« (ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤) -->
        <div id="calc-panel" class="calc-panel">
            <div class="calc-header">
                ç›®æ¨™ã®æ•°å­—ã‚’ä½œã‚Œï¼<br>
                <span id="calc-target" class="calc-target-num">?</span>
            </div>
            <div id="calc-disp" class="calc-display"></div>
            
            <div style="text-align:center; font-size:0.8rem; color:#888; margin-bottom:5px;">è¨˜å·ã¨ã‚«ãƒ¼ãƒ‰ã‚’ã‚¿ãƒƒãƒ—</div>
            <div id="calc-chips" class="calc-chips"></div>
            <div id="calc-hand" class="calc-hand-area"></div>

            <div class="calc-btns">
                <button class="btn-calc btn-clear" onclick="Game.calcClear()">ã‚¯ãƒªã‚¢</button>
                <button class="btn-calc btn-pass" onclick="Game.calcPass()">ãƒ‘ã‚¹</button>
                <button class="btn-calc btn-go" onclick="Game.calcSubmit()">æ±ºå®šï¼</button>
            </div>
        </div>

        <!-- å¾…æ©Ÿã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
        <div id="wait-overlay">
            <div style="font-size:3rem;">â³</div>
            <div id="wait-text">ç›¸æ‰‹ã‚’å¾…ã£ã¦ã„ã¾ã™...</div>
        </div>
    </div>
</div>

<!-- 4. çµæœç”»é¢ -->
<div id="result-modal">
    <div id="result-title">WIN!</div>
    <div id="result-detail" style="margin-bottom:30px;">ç›¸æ‰‹ã®æ‰‹æœ­ãŒå°½ãã¾ã—ãŸ</div>
    <button class="btn btn-primary" onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
</div>

<script>
/**
 * CALC & CRASH - COMPLETE EDITION
 * æ—¥æœ¬èªåŒ–ãƒ»æ“ä½œæ€§æ”¹å–„ãƒ»QRå¯¾å¿œ
 */

// éŸ³å£°ç®¡ç†
const Sound = {
    ctx: null,
    init() { if(!this.ctx) this.ctx = new (window.AudioContext||window.webkitAudioContext)(); },
    play(type) {
        if(!this.ctx) return;
        const t = this.ctx.currentTime;
        const o = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        o.connect(g); g.connect(this.ctx.destination);
        
        if(type === 'select') {
            o.frequency.setValueAtTime(800, t);
            g.gain.exponentialRampToValueAtTime(0.01, t+0.1);
            o.start(); o.stop(t+0.1);
        } else if(type === 'crash') {
            o.type = 'sawtooth';
            o.frequency.setValueAtTime(100, t);
            g.gain.exponentialRampToValueAtTime(0.01, t+0.3);
            o.start(); o.stop(t+0.3);
        } else if(type === 'win') {
            o.type = 'triangle';
            o.frequency.setValueAtTime(440, t); o.frequency.setValueAtTime(880, t+0.1);
            g.gain.linearRampToValueAtTime(0, t+0.4);
            o.start(); o.stop(t+0.4);
        } else if(type === 'error') {
            o.type = 'square';
            o.frequency.setValueAtTime(150, t);
            g.gain.linearRampToValueAtTime(0, t+0.2);
            o.start(); o.stop(t+0.2);
        }
    }
};

// ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç®¡ç†
const Network = {
    peer: null, conn: null, isHost: false, scanner: null,
    
    // ãƒ›ã‚¹ãƒˆåˆæœŸåŒ–
    initHost() {
        Sound.init();
        document.getElementById('net-select-ui').style.display = 'none';
        document.getElementById('net-host-ui').style.display = 'flex';
        
        this.peer = new Peer();
        this.peer.on('open', id => {
            document.getElementById('host-id-text').innerText = id;
            this.isHost = true;
            // QRç”Ÿæˆ
            document.getElementById("qr-display-area").innerHTML = "";
            new QRCode(document.getElementById("qr-display-area"), { text: id, width: 160, height: 160 });
        });
        
        this.peer.on('connection', c => {
            this.conn = c;
            this.setupConnection();
            Game.startOnline(true); // Host is P1
        });
    },

    // ã‚²ã‚¹ãƒˆUIè¡¨ç¤º
    showGuestUI() {
        document.getElementById('net-select-ui').style.display = 'none';
        document.getElementById('net-guest-ui').style.display = 'flex';
    },

    // ã‚«ãƒ¡ãƒ©èµ·å‹•
    startCamera() {
        Sound.init();
        const wrapper = document.getElementById('camera-wrapper');
        wrapper.style.display = 'block';
        this.scanner = new Html5QrcodeScanner("camera-wrapper", { fps: 10, qrbox: 200 });
        this.scanner.render((decoded) => {
            this.join(decoded);
            this.scanner.clear();
            wrapper.style.display = 'none';
        });
    },

    // å…¥åŠ›ã§å‚åŠ 
    joinByInput() {
        const id = document.getElementById('input-host-id').value;
        if(id) this.join(id);
    },

    // å‚åŠ å‡¦ç†
    join(id) {
        Sound.init();
        this.peer = new Peer();
        this.peer.on('open', () => {
            this.conn = this.peer.connect(id);
            this.isHost = false;
            this.setupConnection();
            Game.startOnline(false); // Guest is P2
        });
        this.peer.on('error', () => alert("æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸ"));
    },

    // æ¥ç¶šè¨­å®š
    setupConnection() {
        this.conn.on('data', data => Game.onData(data));
        this.conn.on('close', () => alert("é€šä¿¡ãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ"));
    },

    send(data) {
        if(this.conn) this.conn.send(data);
    }
};

// ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯
const Game = {
    mode: 'local', // 'local' or 'online'
    role: 'p1',    // 'p1' (Host/Self), 'p2' (Guest)
    
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿
    p1: { hand:[1,2,3,5,7,9], chips:['+','-','*','/'], select:null },
    p2: { hand:[1,2,3,5,7,9], chips:['+','-','*','/'], select:null },
    
    attacker: 'p1', // æ”»æ’ƒå´
    phase: 'select', // select, reveal, calc
    calcBuffer: [],

    // ã‚²ãƒ¼ãƒ é–‹å§‹ (ãƒ­ãƒ¼ã‚«ãƒ«)
    initLocal() {
        Sound.init();
        this.mode = 'local';
        this.role = 'p1';
        this.start();
    },

    // ã‚²ãƒ¼ãƒ é–‹å§‹ (ã‚ªãƒ³ãƒ©ã‚¤ãƒ³)
    startOnline(isHost) {
        this.mode = 'online';
        this.role = isHost ? 'p1' : 'p2';
        this.start();
    },

    start() {
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        document.getElementById('screen-game').classList.add('active');
        
        // å…ˆæ”»å¾Œæ”»ãƒ©ãƒ³ãƒ€ãƒ 
        this.attacker = (Math.random() > 0.5) ? 'p1' : 'p2';
        
        // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã®å ´åˆã€ãƒ›ã‚¹ãƒˆãŒå…ˆæ”»æƒ…å ±ã‚’é€ã‚‹
        if(this.mode === 'online' && this.role === 'p1') {
            Network.send({ type: 'init', attacker: this.attacker });
        }
        
        this.updateBoard();
        this.startPhaseSelect();
    },

    // ãƒ•ã‚§ãƒ¼ã‚º1: ã‚«ãƒ¼ãƒ‰é¸æŠ
    startPhaseSelect() {
        this.phase = 'select';
        this.p1.select = null;
        this.p2.select = null;
        
        document.getElementById('slot-p1').innerHTML = 'ã‚ãªãŸ';
        document.getElementById('slot-p2').innerHTML = 'ã‚ã„ã¦';
        document.getElementById('wait-overlay').style.display = 'none';

        if(this.mode === 'local') {
            this.setGuide("ã€P1ã€‘ã‚«ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ãã ã•ã„");
        } else {
            this.setGuide("å ´ã«å‡ºã™ã‚«ãƒ¼ãƒ‰ã‚’é¸ã¼ã†ï¼");
        }
        this.updateBoard();
    },

    // ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯
    clickCard(player, val) {
        if(this.phase !== 'select') return;
        
        // æ“ä½œæ¨©é™ãƒã‚§ãƒƒã‚¯
        if(this.mode === 'online' && player !== this.role) return;
        if(this.mode === 'local' && player === 'p2' && this.p1.select === null) return; // ãƒ­ãƒ¼ã‚«ãƒ«ã¯P1â†’P2ã®é †

        // é¸æŠ
        this[player].select = val;
        Sound.play('select');

        if(this.mode === 'local') {
            if(player === 'p1') {
                document.getElementById('slot-p1').innerHTML = '<div class="card card-back"></div>';
                this.setGuide("ã€P2ã€‘ã‚«ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ãã ã•ã„");
            } else {
                document.getElementById('slot-p2').innerHTML = '<div class="card card-back"></div>';
                setTimeout(() => this.revealCards(), 500);
            }
        } else {
            // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³
            document.getElementById(`slot-${this.role}`).innerHTML = '<div class="card card-back"></div>';
            Network.send({ type: 'select', val: val });
            this.setGuide("ç›¸æ‰‹ã‚’å¾…ã£ã¦ã„ã¾ã™...");
            document.getElementById('wait-overlay').style.display = 'flex';
            this.checkOnlineReady();
        }
        this.updateBoard();
    },

    // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³: ä¸¡è€…é¸æŠå®Œäº†ãƒã‚§ãƒƒã‚¯
    checkOnlineReady() {
        if(this.p1.select !== null && this.p2.select !== null) {
            document.getElementById('wait-overlay').style.display = 'none';
            setTimeout(() => this.revealCards(), 500);
        }
    },

    // ãƒ•ã‚§ãƒ¼ã‚º2: å…¬é–‹
    revealCards() {
        this.phase = 'reveal';
        const v1 = this.p1.select;
        const v2 = this.p2.select;
        
        document.getElementById('slot-p1').innerHTML = `<div class="card">${v1}</div>`;
        document.getElementById('slot-p2').innerHTML = `<div class="card">${v2}</div>`;
        
        if(v1 === v2) {
            Sound.play('crash');
            this.setGuide("ã€ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ï¼ã€‘åŒã˜æ•°å­—ã ï¼");
            setTimeout(() => {
                this.discard('p1', v1);
                this.discard('p2', v2);
                this.checkWinCondition();
            }, 2000);
        } else {
            Sound.play('select');
            this.setGuide("æ•°å­—ãŒé•ã†ï¼è¨ˆç®—ãƒãƒˆãƒ«ç™ºç”Ÿï¼");
            setTimeout(() => this.startPhaseCalc(), 1500);
        }
    },

    // ãƒ•ã‚§ãƒ¼ã‚º3: è¨ˆç®—
    startPhaseCalc() {
        this.phase = 'calc';
        const isAttacker = (this.mode === 'local') ? true : (this.role === this.attacker);
        const target = (this.attacker === 'p1') ? this.p2.select : this.p1.select;
        const myCard = (this.attacker === 'p1') ? this.p1.select : this.p2.select;

        // è¦‹ãŸç›®ã®æ›´æ–°
        this.updateBoard(); // æ”»å®ˆãƒãƒƒã‚¸æ›´æ–°

        if(isAttacker) {
            this.calcBuffer = [{ type:'num', val:myCard }]; // è‡ªåˆ†ã®å‡ºã—ãŸã‚«ãƒ¼ãƒ‰ãŒåˆæœŸå€¤
            document.getElementById('calc-target').innerText = target;
            document.getElementById('calc-panel').classList.add('show');
            this.setGuide("ã€æ”»æ’ƒã€‘è¨ˆç®—ã—ã¦ç›¸æ‰‹ã®æ•°å­—ã‚’ä½œã‚Œï¼");
            this.renderCalcUI();
        } else {
            this.setGuide("ã€å®ˆã‚Šã€‘ç›¸æ‰‹ã®è¨ˆç®—ã‚’å¾…ã£ã¦ã„ã¾ã™...");
            document.getElementById('wait-overlay').style.display = 'flex';
            document.getElementById('wait-text').innerText = "ç›¸æ‰‹ãŒè¨ˆç®—ä¸­...";
        }
    },

    // è¨ˆç®—UIæç”»
    renderCalcUI() {
        const p = this[this.attacker];
        
        // ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤
        document.getElementById('calc-disp').innerText = this.calcBuffer.map(i => i.val).join(' ');

        // è¨˜å·ãƒœã‚¿ãƒ³
        const chipBox = document.getElementById('calc-chips');
        chipBox.innerHTML = '';
        ['+','-','*','/'].forEach(op => {
            const el = document.createElement('div');
            el.className = 'chip';
            el.innerText = op;
            
            // æ‰€æŒæ•°ã¨ä½¿ç”¨æ•°ã‚’æ¯”è¼ƒã—ã¦ä½¿ç”¨å¯å¦åˆ¤å®š
            const hasCount = p.chips.filter(c => c===op).length;
            const usedCount = this.calcBuffer.filter(i => i.type==='op' && i.val===op).length;
            
            if(usedCount >= hasCount) el.classList.add('used');
            
            el.onclick = () => {
                if(!el.classList.contains('used')) {
                    this.calcBuffer.push({ type:'op', val:op });
                    Sound.play('select');
                    this.renderCalcUI();
                }
            };
            chipBox.appendChild(el);
        });

        // æ‰‹æœ­ãƒœã‚¿ãƒ³
        const handBox = document.getElementById('calc-hand');
        handBox.innerHTML = '';
        p.hand.forEach(val => {
            const el = document.createElement('div');
            el.className = 'card';
            el.style.width = '40px'; el.style.height = '55px'; el.style.fontSize = '1.2rem';
            el.innerText = val;

            // ä½¿ç”¨åˆ¤å®š (å‡ºã—ãŸã‚«ãƒ¼ãƒ‰ã¯æœ€åˆã«ä½¿ç”¨æ¸ˆã¿æ‰±ã„ã€‚ãã‚Œä»¥å¤–ã®æ‰‹æœ­ã¯ã‚«ã‚¦ãƒ³ãƒˆæ¯”è¼ƒ)
            const isPlayedCard = (val === p.select);
            const handCount = p.hand.filter(v => v===val).length;
            // ãƒãƒƒãƒ•ã‚¡å†…ã®ä½¿ç”¨æ•°ï¼ˆå…ˆé ­ã®å‡ºã—ãŸã‚«ãƒ¼ãƒ‰ã¯é™¤ãï¼‰
            const usedInBuf = this.calcBuffer.slice(1).filter(i => i.type==='num' && i.val===val).length;
            
            // å‡ºã—ãŸã‚«ãƒ¼ãƒ‰ã¨åŒã˜æ•°å­—ã®æ‰‹æœ­ã‚’ä½¿ã†å ´åˆã€æ‰‹æœ­æšæ•°-1 ã¾ã§ã—ã‹ä½¿ãˆãªã„
            const limit = isPlayedCard ? handCount - 1 : handCount;
            
            if(usedInBuf >= limit) el.classList.add('disabled');

            el.onclick = () => {
                if(!el.classList.contains('disabled')) {
                    this.calcBuffer.push({ type:'num', val:val });
                    Sound.play('select');
                    this.renderCalcUI();
                }
            };
            handBox.appendChild(el);
        });
    },

    // è¨ˆç®—ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
    calcClear() {
        const myCard = (this.attacker === 'p1') ? this.p1.select : this.p2.select;
        this.calcBuffer = [{ type:'num', val:myCard }];
        Sound.play('select');
        this.renderCalcUI();
    },
    
    calcPass() {
        if(!confirm("è¨ˆç®—ã‚’ã‚ãã‚‰ã‚ã¾ã™ã‹ï¼Ÿï¼ˆè‡ªåˆ†ã®ã‚«ãƒ¼ãƒ‰ã¯æ‰‹æœ­ã«æˆ»ã‚Šã¾ã™ï¼‰")) return;
        this.finishCalc(false);
    },

    calcSubmit() {
        const target = (this.attacker === 'p1') ? this.p2.select : this.p1.select;
        const expr = this.calcBuffer.map(i => i.val).join('');
        
        try {
            // å˜ç´”ãªevalä»£æ›¿
            const res = Function('"use strict";return (' + expr + ')')();
            
            if(res === target) {
                Sound.play('win');
                this.finishCalc(true);
            } else {
                Sound.play('error');
                alert(`ç­”ãˆãŒé•ã„ã¾ã™ï¼\nã‚ãªãŸã®ç­”ãˆ: ${res}\nç›®æ¨™ã®æ•°å­—: ${target}`);
            }
        } catch(e) {
            Sound.play('error');
            alert("å¼ãŒå®Œæˆã—ã¦ã„ã¾ã›ã‚“ï¼ˆè¨˜å·ã§çµ‚ã‚ã£ã¦ã„ã‚‹ç­‰ï¼‰");
        }
    },

    finishCalc(success) {
        document.getElementById('calc-panel').classList.remove('show');
        if(this.mode === 'online') {
            Network.send({ type: 'result', success: success, buffer: this.calcBuffer });
        }
        this.resolveRound(success);
    },

    // åˆ¤å®šå‡¦ç†
    resolveRound(success) {
        document.getElementById('wait-overlay').style.display = 'none';

        if(success) {
            this.setGuide("è¨ˆç®—æˆåŠŸï¼ ä¸¡æ–¹ã®ã‚«ãƒ¼ãƒ‰ãŒæ¶ˆæ»…ï¼");
            
            // ã‚³ã‚¹ãƒˆæ”¯æ‰•ã„ (ãƒãƒƒãƒ•ã‚¡ã«ã‚ã‚‹ã‚«ãƒ¼ãƒ‰/ãƒãƒƒãƒ—ã‚’æ¶ˆè²»)
            const atkPlayer = this[this.attacker];
            // ãƒãƒƒãƒ•ã‚¡ã®1ã¤ç›®ã¯å ´ã«å‡ºã—ãŸã‚«ãƒ¼ãƒ‰ãªã®ã§ã‚¹ã‚­ãƒƒãƒ—
            for(let i=1; i<this.calcBuffer.length; i++) {
                const item = this.calcBuffer[i];
                if(item.type === 'num') {
                    const idx = atkPlayer.hand.indexOf(item.val);
                    if(idx !== -1) atkPlayer.hand.splice(idx, 1);
                } else {
                    const idx = atkPlayer.chips.indexOf(item.val);
                    if(idx !== -1) atkPlayer.chips.splice(idx, 1);
                }
            }
            
            // å ´ã«å‡ºãŸã‚«ãƒ¼ãƒ‰ã‚’æ¨ã¦ã‚‹
            this.discard(this.attacker, this[this.attacker].select);
            const def = (this.attacker === 'p1') ? 'p2' : 'p1';
            this.discard(def, this[def].select);

        } else {
            this.setGuide("å¤±æ•—... å®ˆå‚™å´ã®ã‚«ãƒ¼ãƒ‰ã ã‘æ¶ˆæ»…");
            // å®ˆå‚™å´ã®ã‚«ãƒ¼ãƒ‰ã ã‘æ¨ã¦ã‚‹
            const def = (this.attacker === 'p1') ? 'p2' : 'p1';
            this.discard(def, this[def].select);
        }

        setTimeout(() => this.checkWinCondition(), 2500);
    },

    discard(player, val) {
        const arr = this[player].hand;
        const idx = arr.indexOf(val);
        if(idx !== -1) arr.splice(idx, 1);
    },

    // å‹æ•—åˆ¤å®š
    checkWinCondition() {
        const p1Empty = (this.p1.hand.length === 0);
        const p2Empty = (this.p2.hand.length === 0);
        
        if(p1Empty && p2Empty) {
            this.showResult("å¼•ãåˆ†ã‘ï¼");
        } else if(p1Empty) {
            this.showResult(this.mode==='local' ? "ã‚ãªãŸ(P1)ã®å‹ã¡ï¼" : (this.role==='p1'?"ã‚ãªãŸã®å‹ã¡ï¼":"ã‚ã„ã¦ã®å‹ã¡ï¼"));
        } else if(p2Empty) {
            this.showResult(this.mode==='local' ? "ã‚ã„ã¦(P2)ã®å‹ã¡ï¼" : (this.role==='p2'?"ã‚ãªãŸã®å‹ã¡ï¼":"ã‚ã„ã¦ã®å‹ã¡ï¼"));
        } else {
            // æ¬¡ã¸
            this.attacker = (this.attacker === 'p1') ? 'p2' : 'p1';
            this.startPhaseSelect();
        }
    },

    showResult(msg) {
        document.getElementById('result-modal').style.display = 'flex';
        document.getElementById('result-title').innerText = msg;
    },

    // ç”»é¢å…¨ä½“æ›´æ–°
    updateBoard() {
        this.renderHand('p1');
        this.renderHand('p2');
        
        // æ”»å®ˆãƒãƒƒã‚¸è¡¨ç¤º
        const atkBadge = (this.attacker === 'p1') ? document.getElementById('badge-p1') : document.getElementById('badge-p2');
        const defBadge = (this.attacker === 'p1') ? document.getElementById('badge-p2') : document.getElementById('badge-p1');
        
        atkBadge.className = 'role-badge badge-atk'; atkBadge.innerText = 'æ”»æ’ƒ';
        defBadge.className = 'role-badge badge-def'; defBadge.innerText = 'å®ˆã‚Š';
        
        document.getElementById('zone-p1').className = (this.attacker==='p1') ? 'player-zone turn-atk' : 'player-zone turn-def';
        document.getElementById('zone-p2').className = (this.attacker==='p2') ? 'player-zone turn-atk' : 'player-zone turn-def';
    },

    renderHand(player) {
        const container = document.getElementById('hand-'+player);
        container.innerHTML = '';
        const p = this[player];
        
        // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§ç›¸æ‰‹ã®æ‰‹æœ­ãªã‚‰è£å‘ãã«ã™ã‚‹
        const isSecret = (this.mode === 'online' && player !== this.role);

        p.hand.forEach(val => {
            const el = document.createElement('div');
            el.className = 'card';
            
            if(isSecret) {
                el.classList.add('card-back');
            } else {
                el.innerText = val;
                // é¸æŠæ™‚ã®æŒ™å‹•
                if(this.phase === 'select') {
                    if(p.select === val) el.classList.add('selected');
                    else if(p.select !== null) el.classList.add('disabled');
                    
                    el.onclick = () => this.clickCard(player, val);
                }
            }
            container.appendChild(el);
        });
    },

    setGuide(txt) { document.getElementById('guide-text').innerText = txt; },

    // ãƒ‡ãƒ¼ã‚¿å—ä¿¡
    onData(d) {
        if(d.type === 'init') {
            this.attacker = d.attacker;
            this.startPhaseSelect();
        } 
        else if(d.type === 'select') {
            // ç›¸æ‰‹(p2)ãŒé¸æŠã—ãŸ
            // (roleãŒp1ãªã‚‰ç›¸æ‰‹ã¯p2ã€roleãŒp2ãªã‚‰ç›¸æ‰‹ã¯p1)
            const opp = (this.role === 'p1') ? 'p2' : 'p1';
            this[opp].select = d.val;
            
            document.getElementById('slot-'+opp).innerHTML = '<div class="card card-back"></div>';
            this.checkOnlineReady();
        } 
        else if(d.type === 'result') {
            this.calcBuffer = d.buffer; // ç›¸æ‰‹ã®è¨ˆç®—å¼ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆæ¼”å‡ºç”¨ï¼‰
            this.resolveRound(d.success);
        }
    }
};
</script>
</body>
</html>
